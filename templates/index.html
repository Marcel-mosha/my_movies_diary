{% extends 'base.html' %}

{% block title %}My Movie Diary{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-white mb-3 text-shadow">
            {% if user.is_authenticated %}
                My Movie Collection
            {% else %}
                Movie Diary
            {% endif %}
        </h1>
        <p class="lead text-white mb-4 text-shadow">
            {% if user.is_authenticated %}
                Welcome back! Manage your movie ratings and reviews.
            {% else %}
                Track, rate, and review your favorite movies in one place.
            {% endif %}
        </p>
        {% if user.is_authenticated %}
            <a href="{% url 'add_movie' %}" class="btn btn-light btn-lg px-4 shadow-lg">
                <i class="fas fa-plus me-2"></i>Add New Movie
            </a>
        {% else %}
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'register' %}" class="btn btn-light btn-lg px-4 shadow-lg">
                    <i class="fas fa-user-plus me-2"></i>Get Started
                </a>
                <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg px-4 shadow-lg">
                    <i class="fas fa-sign-in-alt me-2"></i>Sign In
                </a>
            </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
        <!-- User's Movie Collection -->
        {% if movies %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
                {% for movie in movies %}
                <div class="col">
                    <div class="card movie-card h-100 shadow-sm border-0 overflow-hidden">
                        <!-- Movie Poster Container -->
                        <div class="movie-poster-container position-relative">
                            <img src="{{ movie.img_url }}" 
                                 alt="{{ movie.title }}"
                                 class="movie-poster-img w-100"
                                 onerror="this.src='https://via.placeholder.com/300x450/6c757d/ffffff?text=No+Poster'">
                            
                            <!-- Overlay with badges -->
                            <div class="movie-overlay position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-between p-3">
                                <!-- Top badges -->
                                <div class="d-flex justify-content-between align-items-start">
                                    <span class="badge ranking-badge bg-primary text-white px-3 py-2">
                                        #{{ movie.ranking }}
                                    </span>
                                    {% if movie.rating %}
                                    <span class="badge rating-badge bg-warning text-dark px-3 py-2">
                                        <i class="fas fa-star me-1"></i>{{ movie.rating }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Bottom action buttons -->
                                <div class="action-buttons translate-y-100">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="{% url 'edit_movie' movie.id %}" 
                                           class="btn btn-sm btn-light rounded-pill px-3 action-btn">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                        <button type="button" 
                                                class="btn btn-sm btn-light rounded-pill px-3 action-btn"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal{{ movie.id }}">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Movie Info -->
                        <div class="card-body p-3">
                            <h6 class="card-title fw-bold text-dark mb-2 text-truncate" title="{{ movie.title }}">
                                {{ movie.title }}
                            </h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">
                                    <i class="fas fa-calendar me-1"></i>{{ movie.year }}
                                </span>
                            </div>
                            <p class="card-text text-muted small mb-2 description-text">
                                {{ movie.description }}
                            </p>
                            
                            {% if movie.review %}
                            <div class="review-section mt-2">
                                <p class="text-muted fst-italic small mb-0 review-text" 
                                   data-full-review="{{ movie.review }}"
                                   data-max-length="80">
                                    "{{ movie.review }}"
                                </p>
                                {% if movie.review|length > 80 %}
                                <button class="btn-read-more btn btn-link p-0 text-primary small" 
                                        onclick="toggleReview(this)">
                                    Read more
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Delete Modal -->
                    <div class="modal fade" id="deleteModal{{ movie.id }}" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm Delete</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <i class="fas fa-exclamation-triangle text-warning fa-2x mb-3"></i>
                                    <p class="mb-1">Delete <strong>"{{ movie.title }}"</strong>?</p>
                                    <p class="text-muted small">This action cannot be undone.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <form method="post" action="{% url 'delete_movie' movie.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5 my-5">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-film fa-4x text-muted"></i>
                </div>
                <h3 class="fw-bold text-dark mb-3">Your collection is empty</h3>
                <p class="text-muted mb-4">Start building your personal movie library by adding your first movie.</p>
                <a href="{% url 'add_movie' %}" class="btn btn-primary btn-lg px-4">
                    <i class="fas fa-plus me-2"></i>Add Your First Movie
                </a>
            </div>
        {% endif %}

    {% else %}
        <!-- Features for Guests -->
        <div class="row g-4 mt-5">
            <div class="col-md-4">
                <div class="text-center p-4 feature-card">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-star fa-2x text-warning"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-white">Rate & Review</h5>
                    <p class="text-white opacity-75">Share your thoughts with personalized ratings and reviews for every movie.</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="text-center p-4 feature-card">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-trophy fa-2x text-warning"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-white">Auto Rankings</h5>
                    <p class="text-white opacity-75">Watch your movies automatically rank based on your personal ratings.</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="text-center p-4 feature-card">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-search fa-2x text-warning"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-white">Smart Search</h5>
                    <p class="text-white opacity-75">Find any movie instantly with our powerful TMDB-powered search.</p>
                </div>
            </div>
        </div>

        <!-- Bottom CTA -->
        <div class="text-center mt-5 pt-5">
            <h4 class="fw-bold text-white mb-3 text-shadow">Ready to start your movie journey?</h4>
            <p class="text-white mb-4 opacity-75">Join thousands of movie lovers tracking their cinematic experiences.</p>
            <a href="{% url 'register' %}" class="btn btn-light btn-lg px-4 shadow-lg">
                <i class="fas fa-rocket me-2"></i>Create Free Account
            </a>
        </div>
    {% endif %}
</div>

<style>
/* Text Shadow for Better Readability on Gradient */
.text-shadow {
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* Button Enhancement for Light Buttons on Gradient */
.btn-light {
    background: rgba(255, 255, 255, 0.95);
    border: none;
    color: #667eea;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-light:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    color: #667eea;
}

.btn-outline-light {
    border: 2px solid rgba(255, 255, 255, 0.9);
    color: #fff;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: #fff;
    color: #fff;
    transform: translateY(-3px);
}

/* Movie Card Styles - Professional Enhancement */
.movie-card {
    border-radius: 16px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: #fff;
    overflow: hidden;
}

.movie-card:hover {
    transform: translateY(-12px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2) !important;
}

/* Movie Poster Container - Enhanced for Full Image Display */
.movie-poster-container {
    height: 420px;
    overflow: hidden;
    border-radius: 12px 12px 0 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
}

.movie-poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.movie-card:hover .movie-poster-img {
    transform: scale(1.08);
}

/* Movie Overlay - Enhanced Gradient */
.movie-overlay {
    background: linear-gradient(to bottom, 
        rgba(0, 0, 0, 0.5) 0%, 
        rgba(0, 0, 0, 0.2) 25%,
        rgba(0, 0, 0, 0) 50%,
        rgba(0, 0, 0, 0.2) 75%,
        rgba(0, 0, 0, 0.6) 100%);
    opacity: 0;
    transition: all 0.4s ease;
}

.movie-card:hover .movie-overlay {
    opacity: 1;
}

/* Badges - Enhanced Style */
.ranking-badge, .rating-badge {
    font-size: 0.9rem;
    font-weight: 700;
    border-radius: 25px;
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    padding: 8px 16px;
}

.ranking-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.rating-badge {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    color: #fff !important;
}

/* Action Buttons - Professional Style */
.action-buttons {
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.movie-card:hover .action-buttons {
    transform: translateY(0);
}

.translate-y-100 {
    transform: translateY(100%);
}

.action-btn {
    font-size: 0.85rem;
    font-weight: 600;
    backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.98) !important;
    border: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.action-btn:hover {
    transform: translateY(-3px) scale(1.08);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    background: rgba(255, 255, 255, 1) !important;
}

/* Text Styles - Enhanced Readability */
.description-text {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.6;
    color: #555;
}

.review-text {
    line-height: 1.5;
    margin-bottom: 0.25rem !important;
    color: #666;
}

.review-text.truncated {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.btn-read-more {
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-read-more:hover {
    text-decoration: underline;
    transform: translateX(3px);
}

/* Feature Cards - Enhanced Professional Style */
.feature-card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.feature-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    background: rgba(255, 255, 255, 0.2);
}

.feature-icon {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.feature-card:hover .feature-icon {
    transform: scale(1.2) rotate(8deg);
}

/* Empty State - Enhanced */
.empty-state-icon {
    opacity: 0.7;
    transition: all 0.4s ease;
}

.empty-state-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* Smooth animations - Enhanced */
.card-body {
    transition: background-color 0.3s ease;
    padding: 1.5rem;
}

.movie-card:hover .card-body {
    background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
}

/* Modal enhancements - Professional Style */
.modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.modal-header {
    border-bottom: 2px solid #e9ecef;
    border-radius: 16px 16px 0 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.modal-footer {
    border-top: 2px solid #e9ecef;
    border-radius: 0 0 16px 16px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

/* Responsive Design - Enhanced */
@media (max-width: 768px) {
    .display-4 {
        font-size: 2.5rem;
    }
    
    .movie-poster-container {
        height: 380px;
    }
    
    .movie-overlay {
        opacity: 1;
        background: linear-gradient(to bottom, 
            rgba(0, 0, 0, 0.5) 0%, 
            rgba(0, 0, 0, 0.2) 25%,
            rgba(0, 0, 0, 0) 50%,
            rgba(0, 0, 0, 0.2) 75%,
            rgba(0, 0, 0, 0.5) 100%);
    }
    
    .action-buttons {
        transform: translateY(0);
    }
    
    .review-text.truncated {
        -webkit-line-clamp: 3;
    }
}

@media (max-width: 576px) {
    .display-4 {
        font-size: 2rem;
    }
    
    .movie-poster-container {
        height: 350px;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
    
    .review-text.truncated {
        -webkit-line-clamp: 4;
    }
}

/* Smooth animations */
.card-body {
    transition: background-color 0.3s ease;
}

.movie-card:hover .card-body {
    background-color: #fafafa;
}

/* Modal enhancements */
.modal-content {
    border-radius: 12px;
    border: none;
}

.modal-header {
    border-bottom: 1px solid #e9ecef;
    border-radius: 12px 12px 0 0;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 12px 12px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-dismiss alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            if (alert.isConnected) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    });
    
    // Add smooth loading animation to cards
    const movieCards = document.querySelectorAll('.movie-card');
    movieCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Initialize review truncation
    initializeReviewTruncation();
});

function initializeReviewTruncation() {
    const reviewElements = document.querySelectorAll('.review-text[data-max-length]');
    
    reviewElements.forEach(reviewEl => {
        const fullReview = reviewEl.getAttribute('data-full-review');
        const maxLength = parseInt(reviewEl.getAttribute('data-max-length'));
        
        if (fullReview.length > maxLength) {
            const truncatedText = '"' + fullReview.substring(0, maxLength) + '..."';
            reviewEl.textContent = truncatedText;
            reviewEl.classList.add('truncated');
        }
    });
}

function toggleReview(button) {
    const reviewSection = button.closest('.review-section');
    const reviewText = reviewSection.querySelector('.review-text');
    const fullReview = reviewText.getAttribute('data-full-review');
    
    if (reviewText.classList.contains('truncated')) {
        // Show full review
        reviewText.textContent = '"' + fullReview + '"';
        reviewText.classList.remove('truncated');
        button.textContent = 'Read less';
    } else {
        // Show truncated review
        const maxLength = parseInt(reviewText.getAttribute('data-max-length'));
        const truncatedText = '"' + fullReview.substring(0, maxLength) + '..."';
        reviewText.textContent = truncatedText;
        reviewText.classList.add('truncated');
        button.textContent = 'Read more';
    }
}
</script>
{% endblock %}